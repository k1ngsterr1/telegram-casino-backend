// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum LanguageCode {
  en
  ru
}

enum SystemKey {
  TELEGRAM_BOT_TOKEN
  WEBAPP_URL
  AVIATOR
  AVIATOR_SERVER_SEED
  DEPOSIT
  UPGRADE
  TELEGRAM_API_ID
  TELEGRAM_API_HASH
  TELEGRAM_SESSION_STRING
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

enum Currency {
  XTR
  TON
}

enum TelegramGiftStatus {
  PENDING
  CONVERTED
  USED
}

enum TelegramGiftType {
  STAR_GIFT
  STAR_GIFT_UNIQUE
}

model User {
  id           String          @id @default(uuid())
  telegramId   String          @unique
  username     String
  photo        String?
  languageCode LanguageCode
  balance      Decimal         @default(0)
  rating       Int             @default(0) // User's rank position based on balance
  isBanned     Boolean         @default(false)
  role         Role            @default(USER)
    
  // Leaderboard stats
  totalSpins   Int             @default(0)  // Количество спинов (открытий кейсов)
  totalVolume  Decimal         @default(0)  // Общий объем ставок

  // Referral system
  referredBy      String?         // ID of user who referred this user

  inventory         InventoryItem[]     @relation("UserInventory")
  bets              Bet[]
  payments          Payment[]
  payouts           Payout[]
  upgrades          Upgrade[]
  referralEarnings  ReferralEarning[]   @relation("ReferrerEarnings") // Earnings as a referrer
  referralSources   ReferralEarning[]   @relation("ReferredUserPayments") // Payments that generated referrals
  telegramGifts     TelegramGift[]      @relation("UserGifts") // Telegram gifts received

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([totalVolume(sort: Desc)])
  @@index([totalSpins(sort: Desc)])

  @@index([balance])
  @@index([referredBy])
}

model InventoryItem {
  id      Int    @id @default(autoincrement())
  userId  String
  prizeId Int
  caseId  Int?

  user         User           @relation("UserInventory", fields: [userId], references: [id])
  prize        Prize          @relation("InventoryPrizes", fields: [prizeId], references: [id])
  case         Case?          @relation("InventoryCase", fields: [caseId], references: [id])
  telegramGift TelegramGift?  @relation("GiftInventoryItem")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, caseId, createdAt])
}

model Prize {
  id        Int     @id @default(autoincrement())
  name      String
  amount    Int
  url       String

  inventory       InventoryItem[] @relation("InventoryPrizes")
  case            CaseItem[]      @relation("GiftItems")
  payouts         Payout[]
  upgradesFrom    Upgrade[]       @relation("UpgradeFromPrize")
  upgradesTo      Upgrade[]       @relation("UpgradeToPrize")
  betPrizes       Bet[]           @relation("BetPrizes")
  starsGiftId     String?          

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TelegramGift {
  id                  Int                   @id @default(autoincrement())
  userId              String
  telegramUserId      String
  telegramMessageId   String
  giftType            TelegramGiftType
  isUnique            Boolean               @default(false)
  starsValue          Int?
  nftTitle            String?
  nftNumber           String?
  nftTotalCount       String?
  nftAttributes       Json?
  senderTelegramId    String?
  senderName          String?
  isAnonymous         Boolean               @default(false)
  status              TelegramGiftStatus    @default(PENDING)
  convertedValue      Int?
  convertedAt         DateTime?
  inventoryItemId     Int?                  @unique
  receivedAt          DateTime
  rawMessage          Json
  
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  
  user                User                  @relation("UserGifts", fields: [userId], references: [id], onDelete: Cascade)
  inventoryItem       InventoryItem?        @relation("GiftInventoryItem", fields: [inventoryItemId], references: [id])
  
  @@unique([telegramUserId, telegramMessageId])
  @@index([userId, status])
  @@index([status])
  @@map("telegram_gifts")
}

model CaseItem {
  id      Int     @id @default(autoincrement())
  name    String
  chance  Decimal
  prizeId Int
  caseId  Int

  prize Prize @relation("GiftItems", fields: [prizeId], references: [id])
  case  Case  @relation("CaseItems", fields: [caseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payout {
  id        Int      @id @default(autoincrement())
  userId    String
  prizeId   Int

  user User @relation(fields: [userId], references: [id])
  prize Prize @relation(fields: [prizeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UpgradeChance {
  id         Int     @id @default(autoincrement())
  multiplier Decimal @unique // Flexible multiplier (e.g., 1.5, 2.0, 3.0, 5.0, 10.0)
  chance     Decimal // Success chance as decimal (0.0 - 1.0)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Upgrade {
  id           Int     @id @default(autoincrement())
  userId       String
  fromPrizeId  Int
  toPrizeId    Int?    // Nullable because it's null if upgrade failed
  multiplier   Decimal // Multiplier used at time of upgrade
  chance       Decimal // Chance at the time of upgrade
  success      Boolean // Whether the upgrade succeeded

  user      User   @relation(fields: [userId], references: [id])
  fromPrize Prize  @relation("UpgradeFromPrize", fields: [fromPrizeId], references: [id])
  toPrize   Prize? @relation("UpgradeToPrize", fields: [toPrizeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}

model Case {
  id      Int        @id @default(autoincrement())
  name    String
  price   Int
  preview String
  items   CaseItem[] @relation("CaseItems")
  inventoryItems InventoryItem[] @relation("InventoryCase")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Aviator {
  id          Int     @id @default(autoincrement())
  startsAt    DateTime
  multiplier  Decimal
  status      AviatorStatus @default(WAITING)
  clientSeed  String?
  nonce       Int     @default(0)

  bets        Bet[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AviatorStatus {
  WAITING   // Ожидание старта (10 секунд)
  ACTIVE    // Игра идет
  FINISHED  // Игра завершена
}

model Bet {
  id         Int      @id @default(autoincrement())
  aviatorId  Int
  userId     String
  amount     Int      // For coin-based bets or initial amount for inventory bets
  cashedAt   Decimal? // Multiplier when cashed out
  prizeId    Int?     // Prize given if inventory bet is cashed out
  isInventoryBet Boolean @default(false) // True if bet was made with inventory item

  aviator Aviator @relation(fields: [aviatorId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
  prize   Prize?  @relation("BetPrizes", fields: [prizeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, aviatorId])
  @@index([aviatorId, cashedAt])
}

model Payment {
  id         String      @id @default(uuid())
  userId     String
  amount     Decimal
  currency   Currency
  status     PaymentStatus @default(PENDING)
  invoiceId  String?   @unique

  user              User              @relation(fields: [userId], references: [id])
  referralEarnings  ReferralEarning[] @relation("PaymentReferrals")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReferralEarning {
  id              Int     @id @default(autoincrement())
  referrerId      String  // User who earned the referral commission
  referredUserId  String  // User who made the deposit
  paymentId       String  // Payment that triggered the commission
  amount          Decimal // Commission amount in XTR
  percentage      Decimal // Commission percentage (0.10 for first, 0.03 for subsequent)
  isFirstDeposit  Boolean // Whether this was from the first deposit

  referrer      User    @relation("ReferrerEarnings", fields: [referrerId], references: [id])
  referredUser  User    @relation("ReferredUserPayments", fields: [referredUserId], references: [id])
  payment       Payment @relation("PaymentReferrals", fields: [paymentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([referrerId, createdAt])
  @@index([referredUserId, createdAt])
  @@index([paymentId])
}

model System {
  id    Int       @id @default(autoincrement())
  key   SystemKey @unique
  value String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Admin {
  id       String @id @default(uuid())
  login    String @unique
  password String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
